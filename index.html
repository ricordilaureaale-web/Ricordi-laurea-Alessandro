<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Ricordi Laurea Alessandro</title>
  <link rel="stylesheet" href="style.css"/>
  <style>
    .hidden { display: none !important; }
    .spinner {
      width: 30px;
      height: 30px;
      border: 3px solid rgba(0, 0, 0, 0.1);
      border-left-color: #3498db;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      display: inline-block;
      margin-bottom: 10px;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
    /* Feedback visivo per successo */
    #fotoNotice.success { color: #2ecc71; }
  </style>
</head>
<body>
  <div class="card">
    <h1>Hey Ciao ðŸ‘‹</h1>
    <p class="sub">Se mi dedichi 2 minuti possiamo creare un bel ricordo per tutti di questa serata</p>

    <div class="progress-wrap"><div class="progress" id="progress" style="width:0%"></div></div>
    <iframe name="hidden_iframe" id="hidden_iframe" style="display:none;"></iframe>

    <form id="gform" action="https://docs.google.com/forms/d/1JQi4mdeecui8nj6S-6AUXiQNHUa4u7MHgdYqvoF4xag/formResponse" method="POST" target="hidden_iframe" novalidate>

      <section class="step active" data-step="1">
        <div class="row">
          <div>
            <label for="nome">Qual Ã¨ il tuo Nome?</label>
            <input id="nome" name="entry.412462958" type="text" autocomplete="given-name" />
          </div>
        </div>
        <div class="actions">
          <a class="btn primary" href="bacheca.html">Vai alla bacheca</a>
          <button type="button" class="btn primary" id="next1">Avanti</button>
        </div>
      </section>

      <section class="step" data-step="2">
        <label for="ricordo">Mi lasci un ricordo di stasera?</label>
        <textarea id="ricordo" name="entry.476871126" placeholder="Scrivi qualcosaâ€¦"></textarea>
        <div class="actions">
          <button type="button" class="btn secondary" id="back2">Indietro</button>
          <button type="button" class="btn primary" id="next2">Avanti</button>
        </div>
      </section>
      
      <section class="step" data-step="3">
        <h3 style="margin:0 0 6px">Vuoi aggiungere delle foto?</h3>
        <p class="sub">Carica i tuoi scatti nella finestra che si aprirÃ , oppure procedi oltre.</p>
        <input type="hidden" id="codiceRisposta" name="entry.697726659">
      
        <div id="statusContainer" style="margin: 20px 0; text-align: center; min-height: 60px;">
          <div id="loadingSpinner" class="hidden">
            <div class="spinner"></div>
            <p class="sub">In attesa delle foto...</p>
          </div>
          <div id="fotoNotice" class="sub" style="font-weight: bold;"></div>
        </div>
      
        <div class="actions" id="fotoActions">
          <button type="button" class="btn secondary" id="back3">Indietro</button>
          <button type="button" class="btn primary" id="openUpload">SÃ¬, carica foto</button>
          <button type="button" class="btn secondary" id="skipPhotos" style="background: #eee; color: #666;">No, vai avanti</button>
          <button type="button" class="btn next hidden" id="next3">Procedi</button>
        </div>
      </section>

      <section class="step" data-step="4">
        <h3 style="margin:0 0 6px">Conferma</h3>
        <p class="sub" id="confirmMsg"></p>
        <div class="actions">
          <button type="button" class="btn secondary" id="back4">Indietro</button>
          <button type="submit" class="btn primary" id="btnSubmit">Invia</button>
        </div>
      </section>

      <section class="step" data-step="5">
        <h2 style="margin:0 0 6px">Grazie mille! ðŸŽ‰</h2>
        <p class="sub">La tua risposta Ã¨ stata registrata. Sei una persona speciale ðŸ’™</p>
        <div class="actions">
          <button type="button" class="btn start" id="backToStart">Compila di nuovo</button>
          <a class="btn primary" href="bacheca.html">Vai alla bacheca</a>
        </div>
      </section>
    </form>
    <footer>Le tue risposte vengono registrate tramite Google Forms.</footer>
  </div>

  <script>
    (function() {
        const CFG = {
            SHEET_FOTO_ID: '1h_GjGsAIm51xnDmn9o0nOyGexCDhXt0BjOy0XgfQz0o',
            GID_FOTO: '389351937'
        };

        const steps = Array.from(document.querySelectorAll('.step'));
        const progress = document.getElementById('progress');
        const form = document.getElementById('gform');
        const iFrame = document.getElementById('hidden_iframe');
        const nome = document.getElementById('nome');
        const codiceInput = document.getElementById('codiceRisposta');
        const confirmMsg = document.getElementById('confirmMsg');
        const openUploadBtn = document.getElementById('openUpload');
        const skipPhotosBtn = document.getElementById('skipPhotos');
        const loadingSpinner = document.getElementById('loadingSpinner');
        const next3 = document.getElementById('next3');
        const fotoNotice = document.getElementById('fotoNotice');

        let current = 0;
        const total = steps.length;
        let pollId = null;
        let popupWin = null;

        function showStep(idx) {
            steps.forEach((s, i) => s.classList.toggle('active', i === idx));
            const pct = Math.round((idx / (total - 1)) * 100);
            progress.style.width = pct + '%';
        }

        function updateSummary() {
            const valNome = nome.value.trim();
            confirmMsg.textContent = valNome 
                ? `Ok ${valNome}, premi "Invia" per salvare il tuo ricordo.` 
                : `Premi "Invia" per salvare il tuo ricordo.`;
        }

        // --- Navigazione ---
        document.getElementById('next1').addEventListener('click', () => {
            current = 1; showStep(current);
        });

        document.getElementById('next2').addEventListener('click', () => {
            if (!codiceInput.value) codiceInput.value = makeCode();
            current = 2; showStep(current);
        });

        document.getElementById('back2').addEventListener('click', () => {
            current = 0; showStep(current);
        });

        // --- Gestione FOTO (Step 3) ---
        openUploadBtn.addEventListener('click', () => {
            if (!codiceInput.value) codiceInput.value = makeCode();
            const url = buildFotoUrl(codiceInput.value);
            popupWin = window.open(url, 'upload_foto', 'width=520,height=760');
            
            openUploadBtn.classList.add('hidden');
            skipPhotosBtn.classList.add('hidden');
            loadingSpinner.classList.remove('hidden');
            fotoNotice.textContent = "In attesa delle foto...";
            
            startPolling();
        });

        skipPhotosBtn.addEventListener('click', () => {
            if (!codiceInput.value) codiceInput.value = "SKIP-" + Date.now().toString(36).toUpperCase();
            updateSummary();
            current = 3; showStep(current);
        });

        next3.addEventListener('click', () => {
            updateSummary();
            current = 3; showStep(current);
        });

        document.getElementById('back3').addEventListener('click', () => {
            current = 1; showStep(current);
        });

        document.getElementById('back4').addEventListener('click', () => {
            current = 2; showStep(current);
        });

        // --- Invio e Reset ---
        document.getElementById('backToStart').addEventListener('click', () => {
            form.reset();
            codiceInput.value = '';
            openUploadBtn.classList.remove('hidden');
            skipPhotosBtn.classList.remove('hidden');
            loadingSpinner.classList.add('hidden');
            fotoNotice.textContent = "";
            current = 0;
            showStep(current);
        });

        let submitted = false;
        form.addEventListener('submit', (e) => {
            submitted = true;
            const btn = document.getElementById('btnSubmit');
            btn.disabled = true;
            btn.textContent = "Invio...";
        });

        iFrame.addEventListener('load', () => {
            if (submitted) {
                current = 4; showStep(current);
                submitted = false;
            }
        });

        // --- Logica Automazione Foto ---
        async function checkPhotosOnce() {
            const code = codiceInput.value;
            if (!code) return;
            try {
                const res = await gvizCheckPhotosByCode(code);
                if (res.count > 0) {
                    if (popupWin && !popupWin.closed) popupWin.close();
                    loadingSpinner.classList.add('hidden');
                    fotoNotice.classList.add('success');
                    fotoNotice.textContent = "âœ… Foto ricevute!";
                    next3.classList.remove('hidden');
                    clearInterval(pollId);
                    setTimeout(() => { 
                      if(current === 2) { 
                        updateSummary(); 
                        current = 3; 
                        showStep(current); 
                      } 
                    }, 1500);
                }
            } catch (e) { console.error("Errore polling:", e); }
        }

        function startPolling() {
            if(pollId) clearInterval(pollId);
            pollId = setInterval(checkPhotosOnce, 4000);
        }

        function makeCode() {
            return 'R' + Date.now().toString(36) + Math.random().toString(36).slice(2, 8).toUpperCase();
        }

        function buildFotoUrl(codice) {
            const BASE = "https://docs.google.com/forms/d/1ogcXWlD7glhcYIX1KIxoPAGZkByk2bG_c9s-KnfnM4E/viewform";
            return `${BASE}?usp=pp_url&entry.496785438=${codice}`;
        }

        async function gvizCheckPhotosByCode(code) {
            const cbName = `__cb_${Date.now()}_${Math.floor(Math.random()*1000)}`;
            return new Promise((resolve, reject) => {
                window[cbName] = (json) => {
                    const rows = json.table.rows.filter(r => {
                        return r.c.some(cell => {
                            const val = cell ? (cell.v || cell.f || '') : '';
                            return String(val).trim().toUpperCase() === code.toUpperCase();
                        });
                    });
                    resolve({ count: rows.length });
                    delete window[cbName];
                };
                const url = `https://docs.google.com/spreadsheets/d/${CFG.SHEET_FOTO_ID}/gviz/tq?gid=${CFG.GID_FOTO}&tqx=out:json;responseHandler:${cbName}`;
                const s = document.createElement('script');
                s.src = url;
                s.onerror = () => { delete window[cbName]; reject(); };
                document.body.appendChild(s);
                setTimeout(() => s.remove(), 2500);
            });
        }
    })();
  </script>
</body>
</html>

